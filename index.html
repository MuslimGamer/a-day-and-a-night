<!DOCTYPE html>
<html>
	<head>		
		<style>
			body {
				margin: 0px;
			}
		</style>
		
		<script src="lib/crafty-min.js"></script>
		<script src="lib/pouchdb-2.0.0.min.js"></script>				
		<script src="src/libraries/session-storage.js"></script>
		
		<!-- JSON data -->
		<script src="data/characters.js"></script>
		<script src="data/maps/worldMap.js"></script>
		<script src="data/maps/house1.js"></script>		
		
		<!-- Preloader -->
		<script src="src/scenes.js"></script>		
		
		<!-- Entities and components -->
		<script src="src/components/components.js"></script>
		<script src="src/components/positionalAudio.js"></script>
		<script src="src/components/interactive.js"></script>
		<script src="src/components/inventory.js"></script>
		
		<script src="src/components/timer.js"></script>
		<script src="src/components/fps.js"></script>		
		
        <script src="src/entities/npcs.js"></script>
        <script src="src/entities/player.js"></script>
        <script src="src/entities/door.js"></script>
        <script src="src/entities/dialogBox.js"></script>
        <script src="src/entities/gameTime.js"></script>
        <script src="src/entities/pointsManager.js"></script>        
        
        <!-- Core game -->
		<script src="src/game.js"></script>
		<script>
			// LOCAL ONLY: get the DIR.
			var loc = window.location.pathname;
			var dir = loc.substring(0, loc.lastIndexOf('/'));
			
			// For production, specify a relative URL
			var gameUrl = dir;
			
			// IE requires "file://" prefixed to gameUrl.
			// To be safe, don't include this in production code.
			var isIe = Object.hasOwnProperty.call(window, "ActiveXObject") && !window.ActiveXObject;
			if (isIe && gameUrl.indexOf('http') != 0) {
				gameUrl = "file://" + gameUrl;
			}
			
			// Reloads the curernt map
			function reloadMap() {				
				var mapName = Game.currentMap.fileName;
				loadMap(mapName);
			}
			
			// Reloads a new map. eg. loadMap("house1")
			function loadMap(mapName) {
				reload("data/maps/" + mapName + ".js");				
				// Not sure why, but the function doesn't re-evaluate
				// to the new value until this function call ends.
				// (eg. worldMap()) -- changing maps works though.
				setTimeout(function() {
					Game.showMap(mapName);
					Game.player.move(3, 3);
				}, 10);				
			}
			
			// private method
			// MOAR debugz: reload scripts on-the-fly
			// http://stackoverflow.com/questions/5285006/is-there-a-way-to-refresh-just-the-javascript-include-while-doing-development			
			function reload(file) {
				// Delete old instances first
				var scripts = document.getElementsByTagName('script');
				for (var i = 0; i < scripts.length; i++) {
					var s = scripts[i];
					if (s.src.indexOf(file) !== -1) {
						document.getElementsByTagName('head')[0].removeChild(s);
					}
				}
										
				var scriptElement = document.createElement('script');
				scriptElement.type = 'text/javascript';
				scriptElement.src = file + '?' + (new Date).getTime();
				document.getElementsByTagName('head')[0].appendChild(scriptElement);				
			}			
			
			window.addEventListener('load', Game.start);
			var debug = true;
		</script>
	</head>
	<body>	
		<div id='cr-stage'></div>
		<input value="list maps" type="submit" onclick="console.debug('Maps:'); var maps = document.getElementsByTagName('script'); for (var i = 0; i < maps.length; i++) { var m = maps[i].src; if (m.indexOf('data/maps') !== -1) { console.debug(m.substring(m.lastIndexOf('/') + 1, m.lastIndexOf('.'))); } }" />
		<input type="text" id="mapName" />
		<input value="change map" type="submit" onclick="loadMap(document.getElementById('mapName').value)" />
		<input value="reload current map" type="submit" onclick="reloadMap()" />
	</body>
</html>
